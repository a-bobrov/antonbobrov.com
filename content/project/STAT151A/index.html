---
title: "An Example of Linear Modeling in R"
subtitle: "UC Berkeley STATA 151A Fall 2021 Final Project"
summary: "Flight delays can be extremely frustrating, especially given the difficulty that consumers can face when trying to predict what factors might make a flight more or less delayed. Being able to predict how late a flight is based on a set of controllable factors would be extremely valuable. Hence, in this project we will attempt to create a model to predict flight delays, using a set of variables that could realistically be controlled by a prospective consumer."
author: "Anton Bobrov, Vincent Chiang, Christopher Tice-Raskin"
date: "2021-12-17"
output: html
---



<div style="page-break-after: always;"></div>
<div id="i.-introduction" class="section level2">
<h2>I. Introduction</h2>
<p>Flight delays can be extremely frustrating, especially given the difficulty that consumers can face when trying to predict what factors might make a flight more or less delayed. Being able to predict how late a flight is based on a set of controllable factors would be extremely valuable. Hence, in this project we will attempt to create a model to predict flight delays, using a set of variables that could realistically be controlled by a prospective consumer.</p>
<p>We will be using the variables Month, Day, Day of the Week, Airline, Origin, Destination, Distance, Scheduled Departure. While this set contains observations from airports across the country, it does not seem reasonable to assume that a consumer could leave from any airport that they wanted. Hence, we will be using a subset of our original data set containing only flights from Oakland, San Francisco, and San Jose. While this limits the predictive power for non-Bay Area fliers, we hope that a similar model could be created to suit the needs of passengers leaving from other locations. Moreover, we will not be using all of the variables in our data set, instead opting to begin by modeling using the month, the day of the week, the airline being flown with, the origin airport (OAK, SFO, or SJC), the destination airport, the scheduled departure (in 24 hour time), and the distance being flown. Our thinking is that these are all variables that could be reasonably controlled by a consumer when choosing a flight.</p>
<p>Since our end-user is a traveler and not a government agency, only a subset of all the variables in our dataset is relevant to answering our research question. A is deciding where to book their ticket and from which airline to do so. They do not have access to information such as actual arrival times, taxi times, reasons for the delay, and other variables like such. A typical user will not have the ability nor the reason to consider these exogenous variables. Taxi time for example is a factor of how busy an airport is, how many planes are allowed in the sky at one time, the season, the weather, the economy, the number of operating airlines, proximity to a city, and various other factors that someone booking a trip will not go through the extreme research lengths to make a decision.</p>
<p>By regressing on the airport (both the destination and departure), we are implicitly able to capture these generalized variables. Likewise, variations in season and holidays are also implicitly captured by Month, Day, and Day of the week since our dataset is restricted to a single year.</p>
<p>Our report will be structured as follows. Section II will be devoted to a brief discussion of the data, its distributions, its limitations, and some transformations we will be applying to it. Section III will discuss our model, and how we came to it. Section IV will be devoted to testing our model and discussing our overall results. Finally, section V will be our conclusion, where we will discuss the results of this testing and possible next steps.</p>
</div>
<div id="ii.-data-description" class="section level2">
<h2>II. Data Description</h2>
<p>Our data is provided by the U.S. Department of Transportation (DOT). The DOT Bureau of Transportation Statistics tracks the on-time performance of domestic flights operated by large air carriers. Summary information on the number of on-time, delayed, canceled, and diverted flights are published in the DOT’s monthly Air Travel Consumer Report where this dataset of 2015 flight delays and cancellations is sourced. The original dataset contains nearly 6 million observations. While this may prove useful about establishing trends about airline on-time performance nationally, for the focus of this project we will only consider flights originating from the 3 major airports of the Bay Area: San Francisco International Airport (SFO), Oakland International Airport (OAK), and Norman Y. Mineta San Jose International Airport (SJC).</p>
</div>
<div id="iii.-data-cleaning-and-preprocessing" class="section level2">
<h2>III. Data Cleaning and Preprocessing</h2>
<p>After extracting all the flight data from SFO, OAK, and SJO, we noticed that there are rows with missing values. This could potentially be the result of human error or data discrepancies across different airports or airlines. To mitigate this issue of regressing on missing values, we took the step of removing all rows with null or missing values. We then removed all the flights that are canceled since a canceled flight should not be part of the model predicting arrival delays. Lastly, we one-hot encoded all of our categorical variables from the last section, creating dummy variables for each airline, month, and day of the week.</p>
<p>Additionally, while this is technically data modification, it was in this step that we discovered that for whatever reason the DOT data that we acquired did not have correct departure airports for October (they were all given in the form of 5 digit numbers that we could not link to any airports). For that reason, October is not included in our analysis.</p>
</div>
<div id="iv.-eda" class="section level2">
<h2>IV. EDA</h2>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>We begin our EDA by looking at the distribution of flight delays. Immediately, we notice that our distribution is not at all symmetric, and thus some kind of data transformation will be required. For our purposes, we will use the log transformation, offsetting our data by <span class="math inline">\(+15\)</span> within it to get rid of any negative values. All in all, our transformed arrival delay will look like the following:</p>
<p><span class="math display">\[Y_i^*=\log(Y_i+15)\]</span></p>
<p>After transformation, our data will look like the following. Additionally, we have included Q-Q plots before and after transformation.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>While our data is still not perfectly symmetric, this transformation helps somewhat, and thus we will proceed with our analysis using exclusively transformed delays. We also made a point of looking at some of our bivariate distributions, of which we decided to highlight airline, month, and day Note that month and day are viewed as factor variables, as viewing them as a strictly continuous variable does not allow for variation outside of just an increasing number.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="768" /></p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="768" /></p>
<p>The following major airline carriers operated in 2015 from SFO, OAK, and SJC: US Airways (US), Delta Airlines (DL), American Airlines (AA), United Airlines (UA), Southwest Airlines (WN), JetBlue Airways (B6), Frontier Airlines (F9), Spirit Airlines (NK), Skywest Airlines (OO), Alaska Airlines (AS), Virgin America (VX), and Hawaiian Airlines (HA). Looking at each of the plots for their bivariate distribution with arrival delays, we can note that there seems to be some variation. Specifically, the boxplots reveal to us that HA (Hawaiian Airlines) seems to have far fewer delays on average than other airlines, with most other airlines looking fairly similar in terms of mean and spread. As for Day and Month, most of the days are fairly close in mean, except for December, which seems to have far more average delay than the other months. All in all, it seems worth including these variables in our model to better analyze these differences.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Finally, we can look at a subset of January to attempt to see the difference that time and day may have on flight delays. Looking at the figure above, we notice both peaks at certain times, as well as peaks on certain days (the 6th, the 11th, etc). This further motivates using scheduled departure as a variable in our model.</p>
</div>
<div id="v.-model-selection" class="section level2">
<h2>V. Model Selection</h2>
<p>The variables that we will be including in our model selection are Month, Day, Day of the week, Airline, Origin, Destination, Distance, Scheduled Departure, and Scheduled Time (Total Trip Duration). Among them, Month, Day of Week, Airline, Origin, and Destination will all be treated as categorical variables (factors), creating a large number of dummy variables. From the exploratory data analysis done in the last section, we can determine it is unlikely that all of these variables will be of significance to our predictive model, therefore, we decided to conduct some forms of variable pruning.</p>
<div id="lasso" class="section level3">
<h3>Lasso</h3>
<p>We performed a LASSO regression in order to prune out insignificant variables. LASSO optimizes the following:</p>
<p><span class="math display">\[\hat{\beta} = argmin_{\beta} ||y - X \beta ||^2 + \lambda \sum_{i=1}^n |\beta_i|\]</span></p>
<p>Lasso regression penalizes large coefficients, and systematically drives insignificant coefficients to 0, effectively pruning them out of our model. Note that in a general LASSO regression, it is necessary to standardize the design matrix to avoid discrepancies in the magnitude of the coefficients. However, our data matrix is composed of only time-dates and categorical variables and not numerical continuous variables that would typically suffer from this procedure. Therefore, we do not need to worry about standardization.</p>
<p>To find the best lambda, we employ hyperparameter tuning through 10-fold cross-validation on our training dataset and subsequently choose the lambda with the lowest mean squared cross-validation error. The figure below shows the plot of cross-validation errors.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
</div>
<div id="vi.-results" class="section level2">
<h2>VI. Results</h2>
<div id="model-summary" class="section level3">
<h3>Model Summary</h3>
<p>The final fitted model that we used for this project is an Ordinary Least Squares model. Our final model has 26931 observations that it was fitted on from the train data. The intercept term is not easily interpretable because there is no default month or travel departure airport. The following are the statistically significant variables that our OLS model returns from the after variable selection in LASSO: <em>March, May, July, September, Sunday, Tuesday, Thursday, Friday, Frontier Airlines, JetBlue Airways, Hawaiian Airlines, Spirit Airlines, United Airlines, Virgin America, Southwest Airlines, SFO, ABQ, AATL, CLT, CMH, DCA, DTW, HDN, IAN, IND, JFK, MSP, ORD, PHL, PSC, RNO, SNA, SUN,</em> and <em>Scheduled departure time</em>.</p>
<p>The variables in a traveler’s control with the largest positive effect on travel delay are the month December, Spirit Airlines, flying to Columbus International Airport, and departing from SFO, with coefficients <span class="math inline">\(-1.338*10^{-1}, 1.641*10^{-1}, 7.75^*10^{-1}, 8.776*10^{-2}\)</span>. That means that flying in December from SFO to Columbus on Spirit Airlines (if such a flight exists) will increase your travel delay by the respective listed values as percentages given all other variables are held constant. This makes sense. December in the United States is historically one of the busiest months to travel. Spirit Airlines is considered an ultra-low cost carrier traditionally with a mixed reputation. Columbus is located in Ohio which often suffers from harsh cold weather, especially during the peak travel season increasing the probability of magnitude of delay.</p>
<p>The variables in a traveler’s control with the largest negative effect on travel delay are the month of September, Hawaiian Airlines, flying to Friedman Memorial Airport in Blaine Idaho, from OAK, with coefficients <span class="math inline">\(-1.021e^{-1}, -1.415*10^{-1}, -3.392*10^{-1}\)</span>. This means that flying in September from OAK to Blaine on Hawaiian (if such a flight exists) will decrease your travel delay by the respective listed values as percentages given all other variables are held constant. This also makes sense. September is not usually a month with peak travel volume and typically fair weather. Hawaiian Airlines flights largely to Hawaii which has fair weather year-round. I’ve never heard of Blaine Idaho before. It is a county with a population of ~21 thousand people, which should reduce the probability of delays.</p>
<p>It is worth noting that not all flight delays that can be predicted exist. For example, Hawaiian does not operate from OAK to Idaho. This should be considered whenever using our model.</p>
</div>
<div id="diagnostics" class="section level3">
<h3>Diagnostics</h3>
<p>After using our LASSO regression for model selection, we fit an ordinary least squares regression (OLS) with only the variables with non-zero coefficients in the best model. Generally, refitting using no penalty after having done variable selection via the LASSO is considered “cheating” since you have already looked at the data and the resulting p-values and confidence intervals are not valid in the usual sense. This particular problem is discussed in the published research paper, “In defense of the Indefensible: A Very Naive approach to high-dimensional inference”, The authors conclude that given a large enough dataset and that our explanatory variables are deterministic, “peeking twice” at the data is acceptable. Thus, due to the composition of our design matrix, we can justify this design choice. LASSO, by construction, produces biased estimates for the coefficients, so we would like an unbiased estimate to have better accuracy and better interpretability in our final model. The scale of the delay time is extremely small in respect to the actual flight time, implying our margin for error is small. Flight times in hours yield regression coefficients of minutes or less. Even small bias introduced to the coefficients of our model may endanger the already limited interpretability of our coefficients.</p>
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-16-1.png" width="768" />
<p>Looking at the figure above, we note the following. First, our plot reveals a significantly non-normal appearing distribution for our residuals. This would be problematic in the case that we wanted to perform inference on our coefficients, but given that we care singularly about prediction, this will not be a problem. Our plot reveals another problem. On the bottom left-hand corner of our model, we observe what seems to be a lower bound on our residuals that slopes down as our fitted values increase. This is likely due to an effective lower bound on Flight Delays. While there is technically no limit to how early our variables can be, there is no flight that arrives earlier than 15 min ahead of schedule, while many flights are significantly later than that. Again, while this would likely be a problem for inference, we are attempting prediction with our model, so it is not much of a concern. The plot shows no discernible trend in our standardized residuals, demonstrating relative homoscedasticity in the distribution of our data points. Finally, while there do seem to be a few points of higher leverage in the plot, we find no values with a Cook’s Distance of greater than <span class="math inline">\(0.5\)</span>, indicating that there do not seem to be any large outliers in our data. Hence, we will not modify our data and proceed to fit and interpret our model as it stands.</p>
</div>
</div>
<div id="vii.-prediction" class="section level2">
<h2>VII. Prediction</h2>
<p>In our data processing phase, we made a point of setting aside a portion of our data to test our model’s predictive power. We can use this set, which includes <span class="math inline">\(8,977\)</span> flights, to attempt to analyze the efficacy of our model. We can do this visually and by comparing the RMSE for both our test and training set. For our training data, we obtain an RMSE of <span class="math inline">\(\approx 0.6712\)</span> and for our test data, we obtain a fairly similar number <span class="math inline">\(\approx 0.655\)</span>. While these values are relatively close to each other and may seem small, it is worth noting that this is in log scale, and these values of RMSE are quite large on a logarithmic scale. This observation is confirmed upon further visual analysis, which gives us the following visualization.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Looking at the above graph, we do note a positive relationship between our actual transformed values and our predicted transformed values, but it is not nearly 1 to 1. More specifically, our model seems to have a great deal of difficulty predicting with higher delay.</p>
</div>
<div id="viii.-discussion" class="section level2">
<h2>VIII. Discussion</h2>
<p>Reflecting on the diagnostics and prediction section above, it is clear that our model suffers from some severe limitations. To begin, our model’s residuals are not at all normally distributed and possess both a light left-hand tail and a heavy right-hand tail, even after performing a log transformation. This limits our abilities to form normal confidence intervals from our model, thus limiting our abilities to perform inference. Outside of that, we also run into problems with performing prediction analysis using our model. Our model has an adjusted <span class="math inline">\(R^2\)</span> of <span class="math inline">\(\approx 0.028\)</span>, implying that only a small portion of the variation in flight delays is accounted for in our data. Moreover, both our test and training data possess fairly large RMSE, indicating a fairly large deviation between what our model predicts and what we see in the data.</p>
<p>All of this together means that our model is not well suited to predict flight delays. While this may seem disheartening after performing all of this analysis, it does give future research into this topic a leg up, as we have established that the variables we analyzed are not predictive of flight delays. Other variables not included with our data may aid with this process, including weather, the number of passengers booked for the flight, the model of the plane, the age of the plane, the price of the flight, and so on. Additionally, other models could likely be explored as well, including models that allow for more interaction between variables or even a multinomial or logistic model that would attempt to predict a degree of lateness, rather than a specific minute count.</p>
</div>
<div id="ix.-conclusion" class="section level2">
<h2>IX. Conclusion</h2>
<p>Unfortunately, the predicting and inferential power of our model yielded limited results. The scale of predicting flight delays given information about origin airports, airlines, scheduled arrival times, and flight distances explains little of the variation in overall flight delays. Our findings suggest that our model could improve by introducing additional variables not present in our dataset. It is likely that factors such as the weather forecast for the time of the flight in both the departure and destination airports greatly influence the likelihood of a flight delay more so than most of the static variables in our model.</p>
<p>Additionally, fitting a linear regression may not have been the most appropriate application for answering the research question. We saw in our exploratory data analysis that the distribution of flight delays even after taking a log transformation is highly right-skewed. Unfortunately, this suggests that our model would not be able to account for the underlying nonlinearities. Moving forward it may be helpful to stratify the outcome variable into groups and predict the probabilities of on-time arrival, light delay, or heavy delay in a multinomial logistic regression model or through a nested regression model. It may be also helpful to analyze the nonlinearities in flight delays through other nonlinear methods such as polynomial regressions and regression splines. These models may be better equipped to handle the degree of heterogeneity present in our data.</p>
</div>
<div id="x.-references" class="section level2">
<h2>X. References</h2>
<p></p>
<p>Zhao, Sen, et al. “In Defense of the Indefensible: A Very Naïve Approach to High-Dimensional Inference.” Statistical Science, vol. 36, no. 4, 2021, <a href="https://doi.org/10.1214/20-sts815" class="uri">https://doi.org/10.1214/20-sts815</a>.</p>
<p>Fox, John. Applied Regression Analysis and Generalized Linear Models. : SAGE Publications, 2008.</p>
<p>US Department of Transportation. (2017, February 9). 2015 Flight Delays and Cancellations (Version 1) [Dataset]. US Department of Transportation. <a href="https://www.kaggle.com/usdot/flight-delays" class="uri">https://www.kaggle.com/usdot/flight-delays</a></p>
<div style="page-break-after: always;"></div>
</div>
<div id="xi.-appendix-all-code-for-this-report" class="section level2">
<h2>XI. Appendix: All code for this report</h2>
<pre class="r"><code>knitr::opts_chunk$set(echo = TRUE)
library(glmnet)
library(dplyr)
library(Rcpp)
library(caret)
library(ggplot2)
library(MASS)
library(gridExtra)
library(lindia)
library(latex2exp)
library(lubridate)
set.seed(69)
flights &lt;- na.omit(read.csv(&quot;Bay_flights.csv&quot;))
regressors &lt;- c(&quot;ARRIVAL_DELAY&quot;, &quot;MONTH&quot;, &quot;DAY_OF_WEEK&quot;, &quot;AIRLINE&quot;, 
                &quot;ORIGIN_AIRPORT&quot;, &quot;DESTINATION_AIRPORT&quot;, 
                &quot;SCHEDULED_DEPARTURE&quot;, &quot;DISTANCE&quot;)

month_graph &lt;- flights$MONTH

day_graph &lt;- flights$DAY_OF_WEEK

airline_graph &lt;- flights$AIRLINE

destination_graph &lt;- flights$DESTINATION_AIRPORT

flights$MONTH &lt;- as.factor(flights$MONTH)

flights$DAY_OF_WEEK &lt;- as.factor(flights$DAY_OF_WEEK)

dummy &lt;- dummyVars(&quot; ~ .&quot;, data = flights[,regressors])

final_df &lt;- data.frame(predict(dummy, newdata=flights[,regressors]))
smp_size &lt;- floor(0.6*nrow(flights))

train_ind &lt;- sample(seq_len(nrow(final_df)), size = smp_size)

train_flights &lt;- final_df[train_ind,]

test_flights &lt;- final_df[-train_ind,]
#Include un-factored versions for graphing
final_df$month_graph &lt;- month_graph

final_df$day_graph &lt;- day_graph

final_df$airline_graph &lt;- airline_graph

final_df$destination_graph &lt;- destination_graph

train_flights_graph &lt;- final_df[train_ind,]

test_flights_graph &lt;- final_df[-train_ind,]
ggplot(data = train_flights_graph) +
  geom_histogram(aes(x = ARRIVAL_DELAY)) +
  labs(title = &quot;Histogram of Arrival Delays&quot;, x = &quot;Delay&quot;, y = &quot;Count&quot;)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<pre class="r"><code>transformedhist &lt;- ggplot(data = train_flights_graph) +
  geom_histogram(aes(x = log(ARRIVAL_DELAY+15)) ) +
  labs(title = &quot;Histogram of Transformed Arrival Delays&quot;, x = &quot;Transformed Delay&quot;, y = &quot;Count&quot;)

delayqq &lt;- ggplot(data = NULL) +
  stat_qq(aes(sample = train_flights_graph$ARRIVAL_DELAY)) +
  stat_qq_line(aes(sample = train_flights_graph$ARRIVAL_DELAY)) +
  labs(title = &quot;Delay Normal Q-Q&quot;,
       x = &quot;Theoretical Quantiles&quot;, y = &quot;Sample Quantiles&quot;)

transformedqq &lt;- ggplot(data = NULL) +
  stat_qq(aes(sample = log(train_flights_graph$ARRIVAL_DELAY+15))) +
  stat_qq_line(aes(sample = log(train_flights_graph$ARRIVAL_DELAY+15))) +
  labs(title = &quot;Transformed  Normal Q-Q&quot;,
       x = &quot;Theoretical Quantiles&quot;, y = &quot;Sample Quantiles&quot;)

grid.arrange(transformedhist, delayqq, transformedqq, ncol = 3)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-2.png" width="672" /></p>
<pre class="r"><code>#Comparing Airlines
US &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;US&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;US Airways&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

DL &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;DL&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;Delta Air Lines&quot;) +
  theme(axis.text=element_text(size=6), 
        axis.title=element_text(size=10))

AA &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;AA&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;American Airlines&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

UA &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;UA&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;United Airlines&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

WN &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;WN&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;Southwest Airlines&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

B6 &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;B6&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;JetBlue Airways&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

F9 &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;F9&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;Frontier Airlines&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

NK &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;NK&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;Spirit Airlines&quot;)+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

OO &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;OO&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;SkyWest Airlines&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

AS &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;AS&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;Alaska Airlines&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

VX &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;VX&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;Virgin America&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

HA &lt;- ggplot(data = train_flights_graph[train_flights_graph$airline_graph == &quot;HA&quot; ,]) + 
  geom_histogram(aes(x = log(ARRIVAL_DELAY + 15))) +
  xlab(&quot;Hawaiian Airlines&quot;) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=10))

grid.arrange(US, DL, AA, UA, WN, B6, F9, NK, OO, AS, VX, HA, ncol = 4)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-3.png" width="672" /></p>
<pre class="r"><code>#Boxplots
months &lt;- ggplot(data = train_flights_graph) + 
  geom_boxplot(aes(y = log(ARRIVAL_DELAY + 15), 
                   x = as.factor(month_graph)) ) + 
  xlab(&quot;Month&quot;) + ylab(&quot;Log (Arrival Delay + 15)&quot;)

days &lt;- ggplot(data = train_flights_graph) + 
  geom_boxplot(aes(y = log(ARRIVAL_DELAY + 15), x = as.factor(day_graph)) ) + 
  xlab(&quot;Day of Week&quot;) + ylab(&quot;Log (Arrival Delay + 15)&quot;)

airlines &lt;- ggplot(data = train_flights_graph) + 
  geom_boxplot(aes(y = log(ARRIVAL_DELAY + 15), x = as.factor(airline_graph))) + 
  xlab(&quot;Airline&quot;) + ylab(&quot;Log (Arrival Delay + 15)&quot;) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=11))

grid.arrange(months, days, airlines, ncol = 3)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-4.png" width="672" /></p>
<pre class="r"><code>#Scatterplot Time

#generate noise
noise_1 &lt;- runif(nrow(train_flights_graph), min = -25, max = 25)
noise_2 &lt;- runif(nrow(train_flights_graph), min = -10, max = 10)

ggplot(data = train_flights_graph, 
       aes(y = log(ARRIVAL_DELAY + 15), x = DISTANCE + noise_1)) + 
  geom_point(size = 0.25) + 
  geom_smooth(method = &quot;lm&quot;, 
              formula = y~x)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-5.png" width="672" /></p>
<pre class="r"><code>ggplot(data = train_flights_graph, 
       aes(y = log(ARRIVAL_DELAY + 15), x = SCHEDULED_DEPARTURE + noise_1)) + 
  geom_point(size = 0.25) + 
  geom_smooth(method = &quot;lm&quot;, formula = y ~x)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-6.png" width="672" /></p>
<pre class="r"><code>ggplot(data = train_flights_graph, 
       aes(y = log(ARRIVAL_DELAY + 15), 
           x = SCHEDULED_DEPARTURE + noise_1, color = as.factor(month_graph))) + 
  geom_point(size = 0.5) + 
  geom_smooth(method = &quot;lm&quot;, formula = y ~x, se = FALSE)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-7.png" width="672" /></p>
<pre class="r"><code>#Temporal Variability of Delay
select_flights &lt;-  flights[, c(&quot;ARRIVAL_DELAY&quot;, &quot;YEAR&quot;, &quot;MONTH&quot;, &quot;DAY&quot;, &quot;SCHEDULED_DEPARTURE&quot;)]


select_flights$date &lt;- make_datetime(year = select_flights$YEAR, 
                                  month = select_flights$MONTH, 
                                  day = select_flights$DAY, 
                                  hour = select_flights$SCHEDULED_DEPARTURE %/% 100,
                                  min = select_flights$SCHEDULED_DEPARTURE %% 100)


ggplot(data = select_flights[select_flights$MONTH == 1 &amp; 
                               select_flights$DAY &gt;= 1 &amp; 
                               select_flights$DAY &lt;=15,  ], 
       aes(x = date, y = log(ARRIVAL_DELAY+15))) + 
    geom_line() + 
    ylab(&quot;Log Arrival Delay&quot;) + xlab(&quot;Date&quot;) +
    scale_x_datetime(breaks = scales::breaks_pretty(14)) +
    theme(axis.text=element_text(size=7),
      axis.title=element_text(size=11))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-8.png" width="672" /></p>
<pre class="r"><code>#Cross Validation to find optimal lambda
cv_model &lt;- cv.glmnet(x = as.matrix(train_flights[-1]), y = log(train_flights[[1]]), alpha = 1)
#using our optimized lambda from before to create a best lasso model
best_lambda &lt;- cv_model$lambda.min
best_model &lt;- glmnet(x = as.matrix(train_flights[-1]), y = log(train_flights[[1]] + 15), alpha = 1, lambda = best_lambda)

#removing rows that are non-zero to extract our coefficients
final_regressors &lt;- rownames(coef(best_model))[coef(best_model)[ ,1] != 0][-1][-11]
#creating a formula for using with lm
regressors &lt;- paste(final_regressors, collapse = &quot; + &quot;)

lasso_formula &lt;- as.formula(paste(&quot;log(ARRIVAL_DELAY) ~ &quot;, regressors, sep = &quot;&quot;))
#lm with reduced set of coefficients
final_model &lt;-lm(data = train_flights, formula = lasso_formula)

summary(final_model)</code></pre>
<pre><code>## 
## Call:
## lm(formula = lasso_formula, data = train_flights)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.5728 -0.5775 -0.1139  0.4786  3.4974 
## 
## Coefficients:
##                          Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)             3.595e+00  3.126e-02 115.011  &lt; 2e-16 ***
## MONTH.1                -2.604e-02  1.785e-02  -1.459 0.144689    
## MONTH.2                 2.223e-02  1.880e-02   1.182 0.237156    
## MONTH.3                -3.833e-02  1.856e-02  -2.065 0.038936 *  
## MONTH.5                -3.980e-02  1.749e-02  -2.275 0.022930 *  
## MONTH.6                 1.831e-02  1.730e-02   1.058 0.289892    
## MONTH.7                 5.127e-02  1.692e-02   3.030 0.002451 ** 
## MONTH.9                -1.021e-01  2.044e-02  -4.996 5.90e-07 ***
## MONTH.11               -2.889e-02  1.939e-02  -1.490 0.136262    
## MONTH.12                1.388e-01  1.639e-02   8.466  &lt; 2e-16 ***
## DAY_OF_WEEK.1           4.326e-02  1.329e-02   3.254 0.001141 ** 
## DAY_OF_WEEK.3          -4.836e-02  1.460e-02  -3.312 0.000926 ***
## DAY_OF_WEEK.5           4.770e-02  1.356e-02   3.517 0.000437 ***
## DAY_OF_WEEK.6          -3.000e-02  1.745e-02  -1.719 0.085545 .  
## DAY_OF_WEEK.7           6.589e-02  1.360e-02   4.845 1.27e-06 ***
## AIRLINEB6              -6.584e-02  3.019e-02  -2.181 0.029180 *  
## AIRLINEF9               8.589e-02  4.278e-02   2.008 0.044703 *  
## AIRLINEHA              -1.415e-01  4.841e-02  -2.923 0.003472 ** 
## AIRLINENK               1.641e-01  5.285e-02   3.104 0.001912 ** 
## AIRLINEOO              -4.990e-03  1.842e-02  -0.271 0.786499    
## AIRLINEUA               3.238e-02  1.759e-02   1.841 0.065593 .  
## AIRLINEUS              -3.110e-02  5.200e-02  -0.598 0.549727    
## AIRLINEVX              -8.399e-02  2.250e-02  -3.732 0.000190 ***
## AIRLINEWN              -8.093e-02  1.898e-02  -4.264 2.01e-05 ***
## ORIGIN_AIRPORTOAK      -1.330e-02  1.570e-02  -0.847 0.397097    
## ORIGIN_AIRPORTSFO       8.776e-02  1.519e-02   5.776 7.76e-09 ***
## DESTINATION_AIRPORTABQ -1.078e-01  6.100e-02  -1.768 0.077074 .  
## DESTINATION_AIRPORTASE  1.263e-01  1.237e-01   1.021 0.307372    
## DESTINATION_AIRPORTATL -1.727e-01  4.620e-02  -3.739 0.000185 ***
## DESTINATION_AIRPORTBNA -2.026e-01  1.537e-01  -1.318 0.187517    
## DESTINATION_AIRPORTBOS  3.824e-02  3.833e-02   0.998 0.318429    
## DESTINATION_AIRPORTBUR  3.588e-02  2.858e-02   1.256 0.209255    
## DESTINATION_AIRPORTBWI -9.045e-02  7.825e-02  -1.156 0.247724    
## DESTINATION_AIRPORTCLT -2.910e-01  7.051e-02  -4.127 3.69e-05 ***
## DESTINATION_AIRPORTCMH  7.750e-01  1.995e-01   3.884 0.000103 ***
## DESTINATION_AIRPORTCOS -7.178e-01  7.163e-01  -1.002 0.316293    
## DESTINATION_AIRPORTDAL -5.263e-02  4.279e-02  -1.230 0.218675    
## DESTINATION_AIRPORTDCA -1.871e-01  8.373e-02  -2.235 0.025443 *  
## DESTINATION_AIRPORTDEN  1.459e-02  2.534e-02   0.576 0.564730    
## DESTINATION_AIRPORTDFW  4.368e-02  3.025e-02   1.444 0.148695    
## DESTINATION_AIRPORTDTW -3.341e-01  8.175e-02  -4.087 4.38e-05 ***
## DESTINATION_AIRPORTFAT  9.160e-02  6.718e-02   1.364 0.172687    
## DESTINATION_AIRPORTHDN -9.640e-01  5.067e-01  -1.902 0.057120 .  
## DESTINATION_AIRPORTHOU -1.153e-01  8.637e-02  -1.335 0.181764    
## DESTINATION_AIRPORTIAH -6.107e-02  3.227e-02  -1.892 0.058449 .  
## DESTINATION_AIRPORTIND  2.435e-01  1.236e-01   1.970 0.048800 *  
## DESTINATION_AIRPORTJAC  1.525e-01  1.127e-01   1.353 0.176016    
## DESTINATION_AIRPORTJFK  1.112e-01  2.934e-02   3.790 0.000151 ***
## DESTINATION_AIRPORTLAX -2.623e-02  1.653e-02  -1.587 0.112518    
## DESTINATION_AIRPORTMCI -9.683e-02  6.684e-02  -1.449 0.147447    
## DESTINATION_AIRPORTMCO -8.428e-02  7.844e-02  -1.074 0.282649    
## DESTINATION_AIRPORTMFR -8.759e-02  5.491e-02  -1.595 0.110711    
## DESTINATION_AIRPORTMMH  1.640e-01  1.920e-01   0.854 0.392989    
## DESTINATION_AIRPORTMRY  1.074e-01  8.531e-02   1.258 0.208254    
## DESTINATION_AIRPORTMSO  3.334e-01  2.392e-01   1.394 0.163432    
## DESTINATION_AIRPORTMSP -1.629e-01  4.846e-02  -3.361 0.000778 ***
## DESTINATION_AIRPORTOGG -3.647e-02  4.510e-02  -0.809 0.418712    
## DESTINATION_AIRPORTONT  3.396e-02  3.035e-02   1.119 0.263154    
## DESTINATION_AIRPORTORD -4.643e-02  2.607e-02  -1.781 0.074920 .  
## DESTINATION_AIRPORTOTH  1.211e-01  9.944e-02   1.217 0.223431    
## DESTINATION_AIRPORTPDX  1.764e-02  2.673e-02   0.660 0.509216    
## DESTINATION_AIRPORTPHL -1.372e-01  5.480e-02  -2.504 0.012301 *  
## DESTINATION_AIRPORTPIT -2.047e-01  1.503e-01  -1.362 0.173333    
## DESTINATION_AIRPORTPSC  2.124e-01  1.127e-01   1.886 0.059372 .  
## DESTINATION_AIRPORTPSP  4.915e-02  4.515e-02   1.089 0.276327    
## DESTINATION_AIRPORTRDU  8.457e-02  9.616e-02   0.880 0.379118    
## DESTINATION_AIRPORTRNO  9.940e-02  5.522e-02   1.800 0.071839 .  
## DESTINATION_AIRPORTSAN  2.025e-02  2.174e-02   0.932 0.351558    
## DESTINATION_AIRPORTSBA  5.243e-02  4.990e-02   1.051 0.293418    
## DESTINATION_AIRPORTSEA -2.795e-02  2.167e-02  -1.290 0.197024    
## DESTINATION_AIRPORTSLC  4.477e-02  2.978e-02   1.503 0.132781    
## DESTINATION_AIRPORTSMF  6.143e-02  5.556e-02   1.106 0.268822    
## DESTINATION_AIRPORTSNA -1.190e-01  2.713e-02  -4.386 1.16e-05 ***
## DESTINATION_AIRPORTSUN -3.392e-01  1.273e-01  -2.664 0.007728 ** 
## DESTINATION_AIRPORTXNA  3.448e-01  3.585e-01   0.962 0.336137    
## SCHEDULED_DEPARTURE     5.147e-05  1.012e-05   5.085 3.69e-07 ***
## DISTANCE               -9.587e-06  1.055e-05  -0.909 0.363518    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.716 on 26854 degrees of freedom
## Multiple R-squared:  0.03102,    Adjusted R-squared:  0.02828 
## F-statistic: 11.31 on 76 and 26854 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>plot(cv_model)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-9.png" width="672" /></p>
<pre class="r"><code>qqresid &lt;- ggplot(data = NULL) + stat_qq(aes(sample = final_model$residuals)) +
  stat_qq_line(aes(sample = final_model$residuals)) +
  labs(title = &quot;Residual Normal Q-Q&quot;,
       x = &quot;Theoretical Quantiles&quot;, y = &quot;Sample Quantiles&quot;)

fittedresid &lt;- ggplot(final_model) + 
  geom_point(aes(x=.fitted, y=.resid), size = 0.5) +
  labs(title = &quot;Fitted Values vs. Residuals&quot;, x = &quot;Fitted Values&quot;,
       y = &quot;Residuals&quot;)

scalelocation &lt;- ggplot(final_model) + 
  geom_point(aes(x=.fitted, y=sqrt(rstandard(final_model))), size = 0.5) + 
  labs(title = &quot;Scale Location&quot;, x = &quot;Fitted Values&quot;, 
       y = TeX(&quot;$$\\sqrt{Standardized Residuals}$$&quot;))

leverage &lt;- gg_resleverage(final_model, method = &quot;loess&quot;,
                           se = FALSE, scale.factor = 1)

grid.arrange(qqresid, fittedresid, scalelocation, leverage, ncol = 2)</code></pre>
<pre><code>## Warning in sqrt(rstandard(final_model)): NaNs produced

## Warning in sqrt(rstandard(final_model)): NaNs produced</code></pre>
<pre><code>## Warning: Removed 14887 rows containing missing values (geom_point).</code></pre>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<pre><code>## Warning: Removed 1 rows containing non-finite values (stat_smooth).</code></pre>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_point).</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-10.png" width="672" /></p>
<pre class="r"><code>sum(cooks.distance(final_model) &gt;= 0.5)</code></pre>
<pre><code>## [1] NA</code></pre>
<pre class="r"><code>predictions &lt;- predict(final_model, newdata = test_flights)

training_predictions &lt;- predict(final_model, newdata = train_flights)

RMSEtest &lt;- sqrt(mean(((log(test_flights[,1]+15) - predictions)^2)))

RMSEtraining &lt;- sqrt(mean(((log(train_flights[,1]+15) - predictions)^2)))</code></pre>
<pre><code>## Warning in log(train_flights[, 1] + 15) - predictions: longer object length is
## not a multiple of shorter object length</code></pre>
<pre class="r"><code>prediction_df &lt;- data.frame(log(test_flights[,1]+15) , predictions)

colnames(prediction_df) &lt;- c(&quot;Actual&quot;, &quot;Predicted&quot;)
ggplot(data = prediction_df, aes(x = Actual, y = Predicted)) + geom_point() + 
  geom_smooth(method = &quot;lm&quot;, se = FALSE) +
  labs( x = &quot;Actual Transformed Delay&quot;,
       y = &quot;Predicted Transformed Delay&quot;)</code></pre>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-11.png" width="672" /></p>
</div>
